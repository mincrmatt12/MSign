# ESP8266

## Pinouts

Debug tx is mapped to `GPIO2`.

TX/RX are on `GPIO13`/`GPIO15`.

SD is wired

| PIN | Mapped |
| --- | ------ |
| `MISO` | `GPIO12` |
| `MOSI` | `GPIO4` |
| `SCK` | `GPIO14` |
| `CS`  | `GPIO5` |

## Update protocol

Open on socket 34476.
This is now semi-deprecated, as the main platform for updating the system will be the WebUI, however config changes are still supported by this api.

Send the text `Mn` to handshake, nothing is returned.

### Commands

| CMD | Meaning |
| --- | ------ |
| `0x10` | Reset |
| `0x20` | Dump config, null terminated string returned |
| `0x30` | Update config |

#### Update config

Send the command, then the config file size, then finally the entire config file.

Returns one of three values

| Value | Meaning |
| --- | ------ |
| `0x10` | File too big |
| `0x11` | Failed to write to SD card |
| `0x00` | OK |

When done, the system resets.

## SD Card

The SD card contains the following files:

```
|
+- config.txt
+- ca
| |
| +- cacert.ar
| --?cacert.idx
|
+-?model.bin
+- web
| |
| +- page.htm
| +- page.js
| -- page.css
--!upd
  |
  +- state.txt
  +- esp.bin
  +- stm.bin
```

Files marked with a `?` are optional, and will either be generated by the system or are not required.

Files marked with a `!` are only present during an update.

### Simple files

- `config.txt` contains the configuration in a simple `key=value` format, comments marked by a leading `#`. The list of keys can be found in `src/config.cpp`.
- `cacert.ar` is the list of ca certificates.
- `model.bin` is an optional 3D model, the default is a baked in M^2 text. The format is simply a 32bit integer of the number of triangles followed by tightly packed floats for each triangle (`xyz*3, rgb`)

### Web files

The `htm` file is served whenever a request is made that _doesn't_ contain a valid API URI.
The other files are served whenever a request for their exact names is made.

The compressed forms of the website files are also cached to internal flash for faster loading.

### Update files

The files in the `upd` folder relate to the ongoing system update.
The `bin` files contain the entire firmware image for the two systems, stored as flat binary files.

State contains an integer with no newline indicating the update state:

| Value | Meaning |
| --- | ---------- |
| `0` | Invalid, the update was interrupted before the download could complete; delete the files |
| `1` | Begin update with these files, i.e. respond with `HANDSHAKE_UOK` |
| `2` | The update was interrupted, tell the STM this through an update status, written after starting STM update |
| `3` | Copy esp.bin to flash |
| `4` | Update succeeded |

These states should progress over time until state 4, which will cause the ESP to respond with a finished message and delete the `upd` folder, going back to a normal boot.
