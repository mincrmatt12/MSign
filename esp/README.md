# ESP8266

## Pinouts

Debug tx is mapped to `GPIO2`.

TX/RX are on `GPIO13`/`GPIO15`.

SD is wired

| PIN | Mapped |
| --- | ------ |
| `MISO` | `GPIO12` |
| `MOSI` | `GPIO4` |
| `SCK` | `GPIO14` |
| `CS`  | `GPIO5` |

(configurable via menuconfig)

## SD Card

The SD card contains the following files:

```
|
+- config.json
+- ca
| |
| -- <sha512 dn hash>
| -- <sha512 dn hash>
+-?model.bin
+-?model1.bin
+-?adc.bin
+- cache
|  |
|  +- ... various directories
+- web
| |
| +- page.html
| +- page.js
| +- page.css
| +- vendor.js
| +-?page.html.gz
| +-?page.js.gz
| +-?page.css.gz
| +-?vendor.js.gz
| +-?etag
--*upd
  |
  +- state
  +- esp.bin
  +- stm.bin
  +- webui.ar
  +- certs.bin
  +- chck.sum
```

Files marked with a `?` are optional, and will either be generated by the system or are not required.

Files marked with a `*` are only present during an update.

Files marked with a `!` are internal only.

### Simple files

- `config.json` contains the configuration for the sign. A reference of keys/values can be found in the various `.cfg.h` files within the main source tree.
- `model.bin` and `model1.bin` are optional 3D models, the default is a baked in M^2 text. The format is simply a 32bit integer of the number of triangles followed by tightly packed floats for each triangle (`xyz*3, rgb`)
- `adc.bin` contains the current calibration for the joystick. If not calibrated, the joystick is ignored (and a warning is shown unless
disabled in the config).

### Web files

The `html` file is served whenever a request is made that _doesn't_ contain a valid API URI.
The other files are served whenever a request matching their name (optionally containing a cache-busting
hash, in which case cache headers are set to cache indefinitely). 
The `etag` file is generated automatically to help with caching and should be deleted after changing the web assets.

### Update files

The files in the `upd` folder relate to the ongoing system update. In general, these should not be touched. To update the webui / certificate bundle it's easier
to manipulate their folders directly; to install new firmware from the SD card see the utilities in the `espweb/` folder.

The `bin` files contain the entire firmware image for the two systems, stored as flat binary files.

State is a single byte indicating the update state. `chck.sum` contains two 16 bit checksums for the
firmware files.

The `webui.ar` file is a normal `.ar` archive containing the new website files. It is written by the webui itself
for an over-the-air update -- updating the files manually in `web/` and deleting `web/etag` is usually faster for a manual
update.

The `certs.bin` file is a custom archive type containing a new block of certificates to install from an over-the-air update. Old certificates
are not removed -- to revoke a certificate the folder must be manually cleaned up.

## TLS files

All the files in the `ca` directory are trusted certificates. The filename is the
subject DN encoded in X.500 form and hashed with SHA512 (stored as hex) and is just
the DER-encoded X.509 certificate.

## Cache files

Files in the `cache` directory are used internally by various grabbers (in general, each grabber
automatically manages its own subfolder). The folder can be safely deleted.
